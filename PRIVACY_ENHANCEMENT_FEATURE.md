# プライバシー保護強化機能 (実験的機能)

**作成日**: 2025年8月23日  
**最終更新**: 2025年8月23日  
**バージョン**: 1.2.0 (実験版)  
**作成者**: AKIO OGAWA

## 概要

Thunderbird 誤送信防止アドオンの実験的機能として、プライバシー保護強化機能と設定機能を実装しました。この機能により、BCC欄のみで送信する際のプライバシー保護をさらに強化し、CC欄の複数アドレス送信を設定で制御できます。

## 機能詳細

### 🔒 プライバシー保護強化機能

#### 動作条件
- **TO欄**: 空（メールアドレスが入力されていない）
- **BCC欄**: 複数のメールアドレスが入力されている（2個以上）

#### 自動処理
1. **送信元アドレスの抽出**: `from`フィールドから送信者のメールアドレスを自動抽出
2. **ユーザー確認**: 自動追加の前にユーザーに確認ダイアログを表示
3. **TO欄への自動追加**: ユーザーの承認後、送信元アドレスをTO欄に自動追加
4. **成功通知**: 処理完了後に通知を表示

#### メリット
- ✅ **完全なプライバシー保護**: 受信者間の相互可視性を完全に遮断
- ✅ **サーバー互換性**: TO欄必須のメールサーバーでも正常動作
- ✅ **ユーザビリティ**: 手動での調整が不要
- ✅ **法的安全性**: 個人情報保護法への準拠強化

#### 注意点
- ⚠️ **メールクライアントの表示**: 一部のクライアントで「自分宛て」と表示される可能性
- ⚠️ **迷惑メールフィルター**: 一部のフィルターでスパム判定される可能性
- ⚠️ **サーバー設定**: 一部のサーバーで送信元アドレスのTO欄追加を拒否する可能性

### ⚙️ 設定機能

#### 設定項目
1. **プライバシー保護強化機能**: 有効/無効の切り替え
2. **CC欄複数アドレス送信**: 許可/禁止の設定
3. **システム通知**: 表示/非表示の設定
4. **詳細ログ**: 出力/非出力の設定

#### 設定画面へのアクセス
- Thunderbirdの設定画面から「アドオン」→「拡張機能」→「設定」ボタン
- または、アドオンの右クリックメニューから「設定」を選択

#### 設定の保存
- 設定は自動的に保存され、アドオンの再起動後も維持されます
- 設定はローカルストレージに保存され、プライバシーが保護されます

## 技術仕様

### 実装詳細

#### 1. 送信元アドレス抽出関数
```javascript
function extractMyEmail(fromField) {
  // オブジェクト形式: { address: "email@domain.com" }
  // 文字列形式: "名前 <email@domain.com>"
  // 直接形式: "email@domain.com"
}
```

#### 2. プライバシー保護強化関数
```javascript
async function enhancePrivacy(tabId, composeDetails) {
  // TO欄が空 && BCC欄に複数アドレスの場合
  // 送信元アドレスをTO欄に自動追加
}
```

#### 3. 設定管理関数
```javascript
async function loadSettings() {
  // ローカルストレージから設定を読み込み
}

async function saveSettings(settings) {
  // ローカルストレージに設定を保存
}

function getSetting(key) {
  // 設定値を取得（デフォルト値のフォールバック付き）
}
```

#### 4. CC欄制御機能
```javascript
// CC欄に複数のメールアドレスがある場合の処理（設定に応じて）
if (ccAddresses.length > 1) {
  if (getSetting('ccMultipleAllowed')) {
    // 送信を許可
    return false;
  } else {
    // 警告を表示して送信を停止
    return true;
  }
}
```

### 設定オプション

```javascript
const DEFAULT_SETTINGS = {
  privacyEnhancement: true,    // プライバシー保護強化機能
  ccMultipleAllowed: false,    // CC欄複数アドレス送信許可
  showNotifications: true,     // システム通知表示
  enableLogging: true          // 詳細ログ出力
};
```

## 使用方法

### 1. 設定の変更
1. Thunderbirdの設定画面を開く
2. 「アドオン」→「拡張機能」を選択
3. 「Thunderbird 誤送信防止アドオン」の「設定」ボタンをクリック
4. 各設定項目を変更
5. 設定は自動的に保存されます

### 2. CC欄の複数アドレス送信
#### 許可する場合
1. 設定画面で「CC欄での複数アドレス送信を許可する」を有効にする
2. CC欄に複数のメールアドレスを入力
3. 通常通り送信（警告なし）

#### 禁止する場合（デフォルト）
1. 設定画面で「CC欄での複数アドレス送信を許可する」を無効にする
2. CC欄に複数のメールアドレスを入力
3. 警告ダイアログが表示され、送信が停止される

### 3. プライバシー保護強化機能
1. 設定画面で「プライバシー保護強化機能を有効にする」を有効にする
2. TO欄を空にしてBCC欄に複数のメールアドレスを入力
3. 送信時に確認ダイアログが表示される
4. 「OK」で自動追加、「キャンセル」で手動調整

## テストケース

### テスト1: 基本動作
- **入力**: TO欄=空, BCC欄=複数アドレス
- **期待結果**: 確認ダイアログ表示 → 自動追加 → 送信成功

### テスト2: ユーザーキャンセル
- **入力**: TO欄=空, BCC欄=複数アドレス
- **期待結果**: 確認ダイアログ表示 → キャンセル → 手動調整推奨

### テスト3: CC欄設定（許可）
- **入力**: CC欄=複数アドレス, 設定=許可
- **期待結果**: 警告なしで送信成功

### テスト4: CC欄設定（禁止）
- **入力**: CC欄=複数アドレス, 設定=禁止
- **期待結果**: 警告表示 → 送信停止

### テスト5: 設定の永続化
- **入力**: 設定変更 → アドオン再起動
- **期待結果**: 設定が維持される

## ログ出力例

```
🔒 プライバシー保護強化機能を開始
📧 TOアドレス数: 0
📧 BCCアドレス数: 3
🔒 プライバシー保護強化の条件を満たしています
📧 送信元アドレス抽出開始: 小川 明男 <firecracker2100@yahoo.co.jp>
📧 名前付き形式から抽出: firecracker2100@yahoo.co.jp
✅ 送信元アドレス抽出成功: firecracker2100@yahoo.co.jp
🔒 プライバシー保護強化確認ダイアログを表示
✅ プライバシー保護強化を実行します
✅ TO欄に送信元アドレスを追加しました: firecracker2100@yahoo.co.jp
```

## 今後の改善予定

### フェーズ1: 実験的機能（現在）
- [x] 基本機能の実装
- [x] ユーザー確認ダイアログ
- [x] エラーハンドリング
- [x] ログ出力
- [x] 設定機能の実装
- [x] CC欄制御機能

### フェーズ2: 機能強化
- [ ] 設定画面での有効/無効切り替え
- [ ] 自動追加の履歴管理
- [ ] より詳細なユーザーガイダンス
- [ ] パフォーマンス最適化
- [ ] 設定のエクスポート/インポート機能

### フェーズ3: 本格実装
- [ ] ユーザーフィードバックの収集
- [ ] 安定性の向上
- [ ] ドキュメントの充実
- [ ] メイン機能への統合

## フィードバック

この実験的機能について、以下の方法でフィードバックをお寄せください：

- **GitHub Issues**: [機能要求・バグ報告](https://github.com/akioogawa/thunderbird-misend-prevention/issues)
- **メール**: firecracker2100@yahoo.co.jp
- **テスト結果**: 実際の使用環境での動作確認結果

## ライセンス

この機能はMITライセンスの下で提供されています。

---

**注意**: この機能は実験的であり、本番環境での使用前に十分なテストを推奨します。
